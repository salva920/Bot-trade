<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .tendency-bull {
            color: #28a745;
            font-weight: bold;
        }
        .tendency-bear {
            color: #dc3545;
            font-weight: bold;
        }
        .tendency-neutral {
            color: #6c757d;
        }
        .signal-alert {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .log-entry {
            border-left: 3px solid #dee2e6;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 0 4px 4px 0;
            font-size: 0.9em;
        }
        .log-entry.INFO { border-left-color: #28a745; }
        .log-entry.WARNING { border-left-color: #ffc107; }
        .log-entry.ERROR { border-left-color: #dc3545; }
        .log-entry.DEBUG { border-left-color: #6c757d; }
        
        .log-level {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
        }
        .log-level.INFO { background: #d4edda; color: #155724; }
        .log-level.WARNING { background: #fff3cd; color: #856404; }
        .log-level.ERROR { background: #f8d7da; color: #721c24; }
        .log-level.DEBUG { background: #e2e3e5; color: #383d41; }
        
        .log-timestamp {
            color: #6c757d;
            font-size: 0.8em;
        }
        
        .signal-mini {
            border-left: 3px solid #dee2e6;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 0 4px 4px 0;
            font-size: 0.9em;
        }
        .signal-mini.BUY { border-left-color: #28a745; }
        .signal-mini.SELL { border-left-color: #dc3545; }
        
        .trade-mini {
            border-left: 3px solid #dee2e6;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 0 4px 4px 0;
            font-size: 0.9em;
        }
        .trade-mini.BUY { border-left-color: #28a745; }
        .trade-mini.SELL { border-left-color: #dc3545; }
        
        .profit-positive { color: #28a745; font-weight: bold; }
        .profit-negative { color: #dc3545; font-weight: bold; }
        .profit-neutral { color: #6c757d; font-weight: bold; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>Bot Trading Pro
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/config">
                    <i class="fas fa-cog me-1"></i>Configuración
                </a>
                <a class="nav-link" href="/logs">
                    <i class="fas fa-list-alt me-1"></i>Logs
                </a>
                <a class="nav-link" href="/signals">
                    <i class="fas fa-chart-line me-1"></i>Señales
                </a>
                <a class="nav-link" href="/trades">
                    <i class="fas fa-exchange-alt me-1"></i>Trades
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Estado del Bot -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-power-off me-2"></i>Estado del Bot
                        </h5>
                        <div class="d-flex align-items-center">
                            <div id="bot-status-indicator" class="me-3">
                                <i class="fas fa-circle text-danger" style="font-size: 1.5rem;"></i>
                            </div>
                            <div>
                                <h6 id="bot-status-text">Desconectado</h6>
                                <small class="text-muted" id="last-check">Última verificación: --</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="start-bot" class="btn btn-success me-2">
                                <i class="fas fa-play me-1"></i>Iniciar Bot
                            </button>
                            <button id="stop-bot" class="btn btn-danger" disabled>
                                <i class="fas fa-stop me-1"></i>Detener Bot
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line me-2"></i>Estadísticas
                        </h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 id="total-signals" class="text-primary">0</h4>
                                <small>Señales</small>
                            </div>
                            <div class="col-4">
                                <h4 id="successful-trades" class="text-success">0</h4>
                                <small>Exitosas</small>
                            </div>
                            <div class="col-4">
                                <h4 id="current-balance" class="text-info">$0</h4>
                                <small>Balance</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tendencias de Timeframes -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-layer-group me-2"></i>Confluencia de Timeframes
                        </h5>
                        <div class="row text-center">
                            <div class="col">
                                <h6>D1</h6>
                                <span id="tendency-d1" class="tendency-neutral">--</span>
                            </div>
                            <div class="col">
                                <h6>H4</h6>
                                <span id="tendency-h4" class="tendency-neutral">--</span>
                            </div>
                            <div class="col">
                                <h6>H1</h6>
                                <span id="tendency-h1" class="tendency-neutral">--</span>
                            </div>
                            <div class="col">
                                <h6>M15</h6>
                                <span id="tendency-m15" class="tendency-neutral">--</span>
                            </div>
                            <div class="col">
                                <h6>M5</h6>
                                <span id="tendency-m5" class="tendency-neutral">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs y Señales en la misma fila -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-list-alt me-2"></i>Logs en Tiempo Real
                            <span class="badge bg-success ms-2" id="logs-count">0</span>
                        </h5>
                        <div id="recent-logs" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Cargando logs...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line me-2"></i>Señales Recientes
                            <span class="badge bg-primary ms-2" id="signals-count">0</span>
                        </h5>
                        <div id="recent-signals" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Cargando señales...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Última Señal -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-bell me-2"></i>Última Señal
                        </h5>
                        <div id="last-signal" class="text-center py-4">
                            <i class="fas fa-clock text-muted" style="font-size: 3rem;"></i>
                            <p class="mt-2 text-muted">Esperando señales...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Trades Recientes -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-exchange-alt me-2"></i>Trades Recientes
                            <span class="badge bg-info ms-2" id="trades-count">0</span>
                        </h5>
                        <div id="recent-trades" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Cargando trades...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        
        // Elementos del DOM
        const startBtn = document.getElementById('start-bot');
        const stopBtn = document.getElementById('stop-bot');
        const statusIndicator = document.getElementById('bot-status-indicator');
        const statusText = document.getElementById('bot-status-text');
        
        // Eventos de botones
        startBtn.addEventListener('click', async () => {
            const response = await fetch('/api/start_bot', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                showAlert('success', data.message);
            } else {
                showAlert('danger', data.message);
            }
        });
        
        stopBtn.addEventListener('click', async () => {
            const response = await fetch('/api/stop_bot', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                showAlert('info', data.message);
            }
        });
        
        // Socket events
        socket.on('bot_update', (data) => {
            updateDashboard(data);
        });
        
        socket.on('new_signal', (signal) => {
            showSignal(signal);
        });
        
        function updateDashboard(data) {
            // Actualizar estado
            if (data.connected) {
                statusIndicator.innerHTML = '<i class="fas fa-circle text-success" style="font-size: 1.5rem;"></i>';
                statusText.textContent = 'Conectado';
            } else {
                statusIndicator.innerHTML = '<i class="fas fa-circle text-danger" style="font-size: 1.5rem;"></i>';
                statusText.textContent = 'Desconectado';
            }
            
            // Actualizar estadísticas
            document.getElementById('total-signals').textContent = data.total_signals;
            document.getElementById('successful-trades').textContent = data.successful_trades;
            document.getElementById('current-balance').textContent = `$${data.current_balance.toFixed(2)}`;
            document.getElementById('last-check').textContent = `Última verificación: ${data.last_check || '--'}`;
            
            // Actualizar tendencias
            if (data.tendencies) {
                updateTendency('d1', data.tendencies.D1);
                updateTendency('h4', data.tendencies.H4);
                updateTendency('h1', data.tendencies.H1);
                updateTendency('m15', data.tendencies.M15);
                updateTendency('m5', data.tendencies.M5);
            }
        }
        
        function updateTendency(timeframe, tendency) {
            const element = document.getElementById(`tendency-${timeframe}`);
            element.textContent = tendency || '--';
            element.className = `tendency-${tendency === 'alcista' ? 'bull' : tendency === 'bajista' ? 'bear' : 'neutral'}`;
        }
        
        function showSignal(signal) {
            const signalDiv = document.getElementById('last-signal');
            const icon = signal.type === 'BUY' ? 'fa-arrow-up' : 'fa-arrow-down';
            const color = signal.type === 'BUY' ? 'success' : 'danger';
            
            signalDiv.innerHTML = `
                <div class="signal-alert">
                    <i class="fas ${icon} text-${color}" style="font-size: 3rem;"></i>
                    <h4 class="mt-2 text-${color}">${signal.type}</h4>
                    <p class="mb-1"><strong>Precio:</strong> ${signal.price}</p>
                    <p class="mb-1"><strong>Factor Riesgo:</strong> ${signal.factor_riesgo.toFixed(2)}</p>
                    <small class="text-muted">${signal.time}</small>
                </div>
            `;
        }
        
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Variables globales para datos
        let logsData = [];
        let signalsData = [];
        let tradesData = [];
        
        // Funciones para formatear datos
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('es-ES');
        }
        
        function formatLogData(data) {
            if (!data || Object.keys(data).length === 0) return '';
            return JSON.stringify(data, null, 2);
        }
        
        function formatProfit(profit) {
            if (profit > 0) return `<span class="profit-positive">+$${profit.toFixed(2)}</span>`;
            if (profit < 0) return `<span class="profit-negative">-$${Math.abs(profit).toFixed(2)}</span>`;
            return `<span class="profit-neutral">$0.00</span>`;
        }
        
        // Función para cargar logs
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs?limit=10');
                logsData = await response.json();
                renderLogs();
            } catch (error) {
                console.error('Error cargando logs:', error);
            }
        }
        
        // Función para cargar señales
        async function loadSignals() {
            try {
                const response = await fetch('/api/signals?limit=10');
                signalsData = await response.json();
                renderSignals();
            } catch (error) {
                console.error('Error cargando señales:', error);
            }
        }
        
        // Función para cargar trades
        async function loadTrades() {
            try {
                const response = await fetch('/api/trades?limit=10');
                tradesData = await response.json();
                renderTrades();
            } catch (error) {
                console.error('Error cargando trades:', error);
            }
        }
        
        // Función para renderizar logs
        function renderLogs() {
            const container = document.getElementById('recent-logs');
            const countElement = document.getElementById('logs-count');
            
            countElement.textContent = logsData.length;
            
            if (logsData.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-inbox fa-2x mb-2"></i><p>No hay logs disponibles</p></div>';
                return;
            }
            
            const logsHtml = logsData.map(log => `
                <div class="log-entry ${log.level}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-timestamp ms-2">${formatTimestamp(log.timestamp)}</span>
                            <div class="mt-1">${log.message}</div>
                            ${log.data && Object.keys(log.data).length > 0 ? 
                                `<div class="mt-1" style="font-size: 0.8em; color: #6c757d;">${formatLogData(log.data)}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = logsHtml;
        }
        
        // Función para renderizar señales
        function renderSignals() {
            const container = document.getElementById('recent-signals');
            const countElement = document.getElementById('signals-count');
            
            countElement.textContent = signalsData.length;
            
            if (signalsData.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-chart-line fa-2x mb-2"></i><p>No hay señales disponibles</p></div>';
                return;
            }
            
            const signalsHtml = signalsData.map(signal => `
                <div class="signal-mini ${signal.type}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge ${signal.type === 'BUY' ? 'bg-success' : 'bg-danger'}">${signal.type}</span>
                            <strong>${signal.price}</strong>
                            <small class="text-muted ms-2">${formatTimestamp(signal.timestamp)}</small>
                        </div>
                        <div>
                            <small class="text-muted">Factor: ${signal.factor_riesgo || 1.0}</small>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = signalsHtml;
        }
        
        // Función para renderizar trades
        function renderTrades() {
            const container = document.getElementById('recent-trades');
            const countElement = document.getElementById('trades-count');
            
            countElement.textContent = tradesData.length;
            
            if (tradesData.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-exchange-alt fa-2x mb-2"></i><p>No hay trades disponibles</p></div>';
                return;
            }
            
            const tradesHtml = tradesData.map(trade => `
                <div class="trade-mini ${trade.type}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge ${trade.type === 'BUY' ? 'bg-success' : 'bg-danger'}">${trade.type}</span>
                            <strong>${trade.symbol}</strong>
                            <small class="text-muted ms-2">${formatTimestamp(trade.timestamp)}</small>
                        </div>
                        <div>
                            <div>${formatProfit(trade.profit_loss || 0)}</div>
                            <small class="text-muted">${trade.status}</small>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = tradesHtml;
        }
        
        // Función para cargar todos los datos
        async function loadAllData() {
            await Promise.all([
                loadLogs(),
                loadSignals(),
                loadTrades()
            ]);
        }
        
        // Cargar estado inicial
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                updateDashboard(data);
                if (data.running) {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                }
            });
        
        // Cargar datos iniciales
        loadAllData();
        
        // Actualizar datos cada 10 segundos
        setInterval(loadAllData, 10000);
    </script>
</body>
</html>
